if (self.CavalryLogger) { CavalryLogger.start_js(["HejXk"]); }

__d('MessengerConversation.react',['cx','csx','fbt','BootloadOnRender.react','ChatTypingIndicators.react','CSS','DOM','DOMDimensions','Event','FluxContainer','immutable','ImmutableObject','JSResource','KeyEventController','LazyComponent.react','MercuryConfig','MercuryIDs','MercuryDeliveryReceipts','mercuryRogerRe','MercuryShareAttachmentRenderLocations','MessageList.react','MessengerAttachmentRenderer','messengerButtonReact','MessengerCollapsedLogMessageGroup.react','MessengerConfig','MessengerContextBannerContainer.react','MessengerDateBreak.react','MessengerFlexScrollableArea.react','MessengerBootloadedLogMessage.react','MessengerMessageGroup.react','messengerNewMessagesNoticeReact','MessengerPlatformSubscriptionMessageClassification','MessengerQuickCamButtonHTML5.react','MessengerQuickCamOrigins','MessengerSpinner.react','MessengerTypingIndicator.react','MessengerVideoAutoplayActions','MessengerVideoAutoplayStore','MNOmniMConstants','OmniMStore','Parent','React','ReactDOM','Set','SubscriptionsHandler','UserActivity','WebMessengerConstants','convertMIGColorToFIGColor','joinClasses','setImmediate','throttle'],(function a(b,c,d,e,f,g,h,i,j){'use strict';var k,l,m=c('MercuryDeliveryReceipts').get(),n=c('mercuryRogerRe').get(),o=c('messengerButtonReact').jsComponent,p=c('messengerNewMessagesNoticeReact').jsComponent,q=c('immutable').OrderedMap,r=c('React').PropTypes,s=20,t=100;function u(event,y){return !!(c('KeyEventController').filterEventTypes(event,y)&&c('KeyEventController').filterEventModifiers(event,y)&&event.target instanceof Element&&c('Parent').bySelector(event.target,"._4_j4"));}k=babelHelpers.inherits(v,c('React').PureComponent);l=k&&k.prototype;function v(){var y,z;for(var aa=arguments.length,ba=Array(aa),ca=0;ca<aa;ca++)ba[ca]=arguments[ca];return z=(y=l.constructor).call.apply(y,[this].concat(ba)),this.state={readReceipts:w(this.props),deliveryTimestamp:0,scrollingToUnreadMessage:false,showUnreadNotice:false,unreadCount:this.props.thread?this.props.thread.unread_count:0,width:0,suggestions:null,omniMPrefs:null},this.$MessengerConversation1=null,this.$MessengerConversation2=0,this.$MessengerConversation3=0,this.$MessengerConversation4=null,this.isScrolledToBottom=function(){return !!(this.refs.scrollable&&this.refs.scrollable.isScrolledToBottom());}.bind(this),this.isScrolledToBottomWithHeight=function(da){return !!(this.refs.scrollable&&this.refs.scrollable.isScrolledToBottomWithHeight(da));}.bind(this),this.$MessengerConversation21=function(){return c('React').createElement(p,{isOpen:this.state.showUnreadNotice,label:j._({"*":"{number} unread messages","268435456":"1 unread message"},[j.plural(this.state.unreadCount,'number')]),onClick:this.$MessengerConversation25});}.bind(this),this.$MessengerConversation23=function(){if(this.props.isLoaded)return null;return c('React').createElement('div',{className:"_2k8v"},this.props.isLoading?c('React').createElement(c('MessengerSpinner.react'),null):null);}.bind(this),this.$MessengerConversation19=function(){return c('React').createElement('div',{className:"_4xu0"},c('React').createElement(c('MessengerSpinner.react'),{className:"_4xu1",size:c('MessengerSpinner.react').Sizes.LARGE}));},this.trackBottomIfRequired=function(){this.refs.scrollable&&this.refs.scrollable.trackBottomIfRequired();}.bind(this),this.scrollToBottom=function(){this.refs.scrollable&&this.refs.scrollable.scrollToBottom();}.bind(this),this.scrollToTop=function(da){this.refs.scrollable&&this.refs.scrollable.scrollToTop(da);}.bind(this),this.$MessengerConversation6=function(){var da=this.$MessengerConversation14();da&&da.pageUp();return false;}.bind(this),this.$MessengerConversation7=function(){var da=this.$MessengerConversation14();da&&da.pageDown();return false;}.bind(this),this.$MessengerConversation8=function(da){if(da.target===document.body){this.scrollToTop();return false;}return null;}.bind(this),this.$MessengerConversation9=function(da){if(da.target===document.body){this.scrollToBottom();return false;}return null;}.bind(this),this.$MessengerConversation12=function(){if(!this.refs.scrollable)return;var da=this.$MessengerConversation14(),ea=this.refs.quickReply;ea&&c('CSS').conditionClass(ea,"_1mzg",!this.isScrolledToBottom());this.$MessengerConversation10();this.$MessengerConversation11();if(da&&this.state.unreadCount&&this.$MessengerConversation18(da))this.setState({showUnreadNotice:false,unreadCount:0});this.$MessengerConversation26(da);}.bind(this),this.$MessengerConversation25=function(da){da.preventDefault();this.setState({showUnreadNotice:false});this.$MessengerConversation16();}.bind(this),this.$MessengerConversation24=function(da){return function(){if(this.props.threadID!==da)return;this.trackBottomIfRequired();}.bind(this);}.bind(this),this.$MessengerConversation15=function(){c('DOM').scry(c('ReactDOM').findDOMNode(this),'img').forEach(function(da){if(da.complete)return;var ea=this.props.threadID,fa=c('Event').listen(da,'load',function(){if(this.props.threadID===ea)this.trackBottomIfRequired();fa.remove();}.bind(this));}.bind(this));}.bind(this),this.$MessengerConversation27=function(){var da=this.props.messages,ea=this.state.unreadCount;if(!ea||ea>da.size)return null;return da.get(da.size-ea);}.bind(this),this.$MessengerConversation18=function(da){var ea=this.$MessengerConversation27();if(!ea)return false;var fa=this.refs.messageList.getMessageElement(ea.message_id);if(!fa)return false;var ga=fa.getBoundingClientRect().top,ha=da.getElement().getBoundingClientRect().top;if(ga-ha<0)return false;return true;}.bind(this),this.$MessengerConversation28=function(da){return !!this.props.messages.find(function(ea){return ea.message_id===da;});}.bind(this),this.$MessengerConversation16=function(){if(!this.state.unreadCount)return;this.setState({scrollingToUnreadMessage:true});var da=this.$MessengerConversation27();if(!da){this.scrollToTop(false);return;}this.$MessengerConversation29(da.message_id,function(){this.setState({scrollingToUnreadMessage:false,unreadCount:0});}.bind(this));}.bind(this),this.$MessengerConversation29=function(da,ea){var fa=this.refs.messageList.getMessageElement(da,true),ga=this.$MessengerConversation14();if(!fa||!ga)return;var ha=fa.getBoundingClientRect().top,ia=c('ReactDOM').findDOMNode(this.refs.messageList).getBoundingClientRect().top,ja=ga.getElement().getBoundingClientRect().top,ka=ha+Math.abs(ia)+ja;ga.setScrollTop(ka,true,{callback:ea});}.bind(this),this.$MessengerConversation11=function(){if(!this.isScrolledToBottom()||this.props.messages.size===0)return;if(c('UserActivity').isOnTab()&&c('UserActivity').isActive()){this.props.onRead(this.props.threadID);}else if(!this.$MessengerConversation4)this.$MessengerConversation4=c('UserActivity').subscribe(function(){if(c('UserActivity').isOnTab()){this.$MessengerConversation13();this.props.onRead(this.props.threadID);}}.bind(this));}.bind(this),this.handleResize=function(){if(this.refs.scrollable){this.refs.scrollable.handleResize();var da=c('DOMDimensions').getElementDimensions(c('ReactDOM').findDOMNode(this.refs.scrollable)).width;if(da!==this.state.width)this.setState({width:da});}var ea=this.refs.quickReply;ea&&c('CSS').conditionClass(ea,"_1mzg",!this.isScrolledToBottom());this.trackBottomIfRequired();}.bind(this),this.$MessengerConversation14=function(){return this.refs.scrollable&&this.refs.scrollable.getArea();}.bind(this),this.$MessengerConversation13=function(){this.$MessengerConversation4&&this.$MessengerConversation4.unsubscribe();this.$MessengerConversation4=null;}.bind(this),z;}v.getStores=function(){return [c('OmniMStore')];};v.calculateState=function(y,z){if(!c('MercuryIDs').isValid(z.threadID))return babelHelpers['extends']({},y);return {suggestions:c('OmniMStore').suggestionsForThread(z.threadID),omniMPrefs:c('OmniMStore').prefs()};};v.prototype.componentDidMount=function(){var y=new (c('SubscriptionsHandler'))();y.addSubscriptions(c('Event').listen(window,'resize',c('throttle')(this.handleResize,50)),c('KeyEventController').registerKey('PAGE_UP',this.$MessengerConversation6,u),c('KeyEventController').registerKey('PAGE_DOWN',this.$MessengerConversation7,u),c('KeyEventController').registerKey('HOME',this.$MessengerConversation8,u),c('KeyEventController').registerKey('END',this.$MessengerConversation9,u),n.subscribe('change',function(z,aa){aa[this.props.threadID]&&this.setState({readReceipts:w(this.props)});}.bind(this)),m.subscribe('change',function(z,aa){this.setState({deliveryTimestamp:this.props.threadID?m.getDeliveryTime(this.props.threadID):0});}.bind(this)));this.$MessengerConversation1=y;this.$MessengerConversation10();this.handleResize();this.$MessengerConversation11();this.$MessengerConversation5=c('throttle')(this.$MessengerConversation12,t);};v.prototype.componentWillReceiveProps=function(y){var z=y.threadID!==this.props.threadID;if(z){this.$MessengerConversation13();this.setState({scrollingToUnreadMessage:false,showUnreadNotice:false,unreadCount:y.thread?y.thread.unread_count:0});}if(z||y.messages!==this.props.messages)this.setState({readReceipts:w(y),deliveryTimestamp:y.threadID?m.getDeliveryTime(y.threadID):0});};v.prototype.componentWillUnmount=function(){this.$MessengerConversation13();this.$MessengerConversation1&&this.$MessengerConversation1.release();};v.prototype.componentWillUpdate=function(){var y=this.$MessengerConversation14();if(y){this.$MessengerConversation2=y.getScrollHeight();this.$MessengerConversation3=y.getScrollTop();}};v.prototype.componentDidUpdate=function(y){if(!this.refs.scrollable)return;if(this.props.threadID!==y.threadID||x(y,this.props)){this.scrollToBottom();this.$MessengerConversation15();}else{var z=this.$MessengerConversation14();if(z){var aa=z.getScrollHeight();if(aa!==this.$MessengerConversation2){var ba=z.getScrollHeight()-this.$MessengerConversation2+this.$MessengerConversation3;this.refs.scrollable.scrollToPosition(ba);}else this.$MessengerConversation15();}}if(this.props.messages!==y.messages){this.$MessengerConversation11();if(this.state.scrollingToUnreadMessage)this.$MessengerConversation16();c('MessengerVideoAutoplayActions').updateStore(this.props.threadID,this.$MessengerConversation17());}setTimeout(function(){var ca=this.$MessengerConversation14();this.trackBottomIfRequired();if(ca&&this.state.unreadCount&&!this.state.scrollingToUnreadMessage&&!this.props.isLoading)if(this.$MessengerConversation18(ca)){this.setState({showUnreadNotice:false,unreadCount:0});}else this.setState({showUnreadNotice:true});this.$MessengerConversation10();}.bind(this),0);};v.prototype.render=function(){if(this.props.isLoading&&this.props.messages.isEmpty())return this.$MessengerConversation19();var y=this.props.messages.last(),z=c('MercuryIDs').getParticipantIDFromUserID(this.props.viewer),aa=null,ba=null,ca=this.state.suggestions||{},da=ca.quickReplies,ea=ca.agentSuggestions;if(!da||!da.length)da=this.$MessengerConversation20(y);if(da&&da.length&&y.author!==z){aa=da;ba=c('MNOmniMConstants').QUICKREPLIES;}else if(ea&&ea.length&&c('MercuryConfig').EnableOmniM){aa=ea;ba=c('MNOmniMConstants').OMNIM;}var fa=aa&&aa.length&&aa.filter(function(oa){return !oa.dismissed;}).length?c('React').createElement(c('BootloadOnRender.react'),{component:c('React').createElement(c('LazyComponent.react'),{options:aa,threadID:y.thread_id,source:ba,omniMPrefs:this.state.omniMPrefs}),loader:c('JSResource')('MessengerBotsQuickReplyButtonList.react').__setRef('MessengerConversation.react'),placeholder:c('React').createElement('div',null)}):null,ga=null;if(y&&y.message_source&&y.author!==z&&c('MercuryConfig').WebCamQuickReply){var ha=y.message_source;if(ha==='camera'){var ia=this.props.thread?c('convertMIGColorToFIGColor')(this.props.thread.custom_color):null,ja=c('React').createElement('div',{className:"_1gc5",style:ia&&{color:ia}},j._("Send a photo reply"));ga=c('React').createElement('div',{className:"_1gc6"},c('React').createElement(c('MessengerQuickCamButtonHTML5.react'),{className:"_4rv5"+(' '+"_1gcb"),location:c('MessengerQuickCamOrigins').MESSENGER,threadID:this.props.threadID,viewer:this.props.viewer,textChild:ja}));}}var ka=null,la=null;if(ga||fa){ka=c('React').createElement('div',{className:"_51op"},c('React').createElement('div',{className:"_51oq",onResize:this.handleResize}));la=c('React').createElement('div',{ref:'quickReply'},c('React').createElement('div',{className:"_1mzb",onResize:this.handleResize},ga,fa));}var ma=j._("Messages"),na=j._("Load more...");return c('React').createElement(c('MessengerFlexScrollableArea.react'),{className:this.props.className,flexChildren:this.$MessengerConversation21(),footerChildren:la,onMount:function(){return c('setImmediate')(this.$MessengerConversation11);}.bind(this),onScroll:this.props.useManualFetch?undefined:this.$MessengerConversation5,ref:'scrollable',shouldStickToBottom:true,tabIndex:0,useScrollProtection:c('MessengerConfig').ChatScrollInterval},c('React').createElement('div',{'aria-label':ma,className:c('joinClasses')("__i_",this.props.innerClassName),role:'region'},c('React').createElement('h3',{className:"accessible_elem"},ma),this.$MessengerConversation22(),this.props.useManualFetch&&!this.props.upExhausted?c('React').createElement(o,{className:"_41jf",label:na,onClick:function(){return this.props.fetchMessages(c('WebMessengerConstants').MORE_SEARCH_CONTEXT_UP);}.bind(this),type:'primary',use:'default'}):null,this.$MessengerConversation23(),c('React').createElement(c('MessageList.react'),{DateBreak:c('MessengerDateBreak.react'),deliveryTimestamp:this.state.deliveryTimestamp,isCanonical:this.props.isCanonical,LogMessage:c('MessengerBootloadedLogMessage.react'),CollapsedLogMessageGroup:c('MessengerCollapsedLogMessageGroup.react'),MessageGroup:c('MessengerMessageGroup.react'),messages:this.props.messages,onAttachmentLoad:this.$MessengerConversation24(this.props.threadID),readReceipts:this.state.readReceipts,ref:'messageList',location:c('MercuryShareAttachmentRenderLocations').MESSENGER,viewer:this.props.viewer,thread:this.props.thread}),this.props.useManualFetch&&!this.props.downExhausted?c('React').createElement(o,{className:"_41jf",label:na,onClick:function(){return this.props.fetchMessages(c('WebMessengerConstants').MORE_SEARCH_CONTEXT_DOWN);}.bind(this),type:'primary',use:'default'}):null,c('React').createElement(c('ChatTypingIndicators.react'),{indicatorClass:c('MessengerTypingIndicator.react'),indicatorsDidShow:function(){this.trackBottomIfRequired();}.bind(this),rootClassName:"clearfix _17pz",threadID:this.props.threadID,viewer:this.props.viewer}),ka));};v.prototype.$MessengerConversation20=function(y){var z=null,aa=y&&y.platform_xmd&&JSON.parse(y.platform_xmd),ba=aa&&aa.message_classification===c('MessengerPlatformSubscriptionMessageClassification').AD_MESSAGE;if(ba)z=aa&&aa.quick_replies;return z;};v.prototype.$MessengerConversation10=function(){if(this.props.useManualFetch)return;var y=this.$MessengerConversation14();if(y&&y.getScrollTop()<s){this.props.fetchMessages(c('WebMessengerConstants').MORE_SEARCH_CONTEXT_UP);c('MessengerVideoAutoplayActions').updateStore(this.props.threadID,this.$MessengerConversation17());}};v.prototype.$MessengerConversation22=function(){if(!this.props.isLoaded)return null;return c('React').createElement(c('MessengerContextBannerContainer.react'),{location:c('MercuryShareAttachmentRenderLocations').MESSENGER,threadID:this.props.threadID,viewer:this.props.viewer});};v.prototype.$MessengerConversation17=function(){return this.props.messages.filter(function(y){return c('MessengerAttachmentRenderer').isSingleVideoAttachment(y)||c('MessengerAttachmentRenderer').isSharedVideoAttachmentMessage(y);}).reverse().map(function(y){return y.message_id;});};v.prototype.$MessengerConversation26=function(y){var z=this.refs.messageList;if(!z||!y)return;var aa=[],ba=y.getElement().getBoundingClientRect(),ca=c('MessengerVideoAutoplayStore').getMessageIDs(this.props.threadID),da=ca||this.$MessengerConversation17()||c('immutable').List();da.map(function(ea){var fa=c('MessengerAttachmentRenderer').getVideoElem(ea,z);if(fa)aa.push([ea,fa.getBoundingClientRect()]);});if(aa.length)c('MessengerVideoAutoplayActions').onScroll(this.props.threadID,ca?null:da,c('immutable').Map(aa),ba);};v.propTypes={contact:r.instanceOf(c('ImmutableObject')),downExhausted:r.bool,fetchMessages:r.func.isRequired,innerClassName:r.string,isCanonical:r.bool,isLoaded:r.bool,isLoading:r.bool,messages:r.instanceOf(c('immutable').List).isRequired,participants:r.instanceOf(c('immutable').Map),thread:r.object,threadID:r.string.isRequired,upExhausted:r.bool,useManualFetch:r.bool,viewer:r.string.isRequired};function w(y){var z=c('MercuryIDs').getParticipantIDFromUserID(y.viewer),aa=n.getSeenTimestamps(y.threadID),ba=new (c('Set'))(y.thread?y.thread.participants:aa.keys());ba['delete'](z);return aa.withMutations(function(ca){c('immutable').Seq(y.messages).reverse().forEach(function(da){if(ba.size===0)return false;if(!ba.has(da.author))return;ca.update(da.author,function(ea){if(!ea||ea.watermark<=da.timestamp)return {watermark:da.timestamp,action:da.timestamp};return ea;});ba['delete'](da.author);});});}function x(y,z){var aa=c('MercuryIDs').getParticipantIDFromUserID(z.viewer);return z.threadID===y.threadID&&z.messages!==y.messages&&!z.messages.isEmpty()&&z.messages.last()!==y.messages.last()&&z.messages.last().author===aa;}f.exports=c('FluxContainer').create(v,{withProps:true});}),null);