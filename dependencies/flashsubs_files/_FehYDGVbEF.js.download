if (self.CavalryLogger) { CavalryLogger.start_js(["G\/VuK"]); }

__d('MercurySearchSnippetResults',['MessengerEnvironment','MercuryAPIArgsSource','MercuryIDs','MercurySingletonMixin','MercuryThreadlistConstants','MercuryThreadIDMap','RangedCallbackManager','MercuryServerDispatcher','MercuryServerPayloadPreprocessor'],(function a(b,c,d,e,f,g){var h=c('MessengerEnvironment').messengerui?c('MercuryAPIArgsSource').MESSENGER:c('MercuryAPIArgsSource').WEBMESSENGER,i={},j={},k=null,l=c('MercuryThreadlistConstants').WEBMESSENGER_SEARCH_SNIPPET_COUNT,m=c('MercuryThreadlistConstants').WEBMESSENGER_SEARCH_SNIPPET_LIMIT,n=c('MercuryThreadlistConstants').WEBMESSENGER_SEARCH_SNIPPET_MORE;function o(x){'use strict';this.$MercurySearchSnippetResults1=x;this.$MercurySearchSnippetResults2=c('MercuryServerPayloadPreprocessor').getForFBID(x);c('MercuryServerDispatcher').registerEndpoints({'/ajax/mercury/search_snippets.php':{request_user_id:x,mode:c('MercuryServerDispatcher').IMMEDIATE,handler:function(y){this.handleUpdate(y);}.bind(this)}});this.$MercurySearchSnippetResults3=c('MercuryThreadIDMap').getForFBID(x);}o.prototype.getFBID=function(){'use strict';return this.$MercurySearchSnippetResults1;};o.prototype.getThreadIDMap=function(){'use strict';return this.$MercurySearchSnippetResults3;};o.prototype.getAllThreadSearchResults=function(x,y){'use strict';if(x)p(this.$MercurySearchSnippetResults1,x,m,0,y);};o.prototype.getAllLocalThreadSearchResults=function(x,y){'use strict';if(x){var z=i[x];if(z){var aa=z.getCurrentArraySize();p(this.$MercurySearchSnippetResults1,x,0,aa,y);}}};o.prototype.getAllThreadSearchMoreResults=function(x,y){'use strict';if(x){var z=i[x];if(z){var aa=z.getCurrentArraySize();p(this.$MercurySearchSnippetResults1,x,n,aa,y);}}};o.prototype.getSingleThreadSearchResults=function(x,y,z){'use strict';if(!x||!y)return;q.call(this,x,y,l,0,z);};o.prototype.getSingleThreadSearchMoreResults=function(x,y,z){'use strict';if(!x||!y)return;if(!j[y])return;var aa=j[y][x];if(aa){var ba=aa.num_total_snippets,ca=aa.snippets_cbm.getCurrentArraySize(),da=ba-ca;if(da>0){var ea=da>n?n:da;q.call(this,x,y,ea,ca,z);}}};o.prototype.countSnippetsMatchingQueryInThread=function(x,y){'use strict';var z=j[y][x];if(z)return z.num_total_snippets;};o.prototype.findIndexOfSnippet=function(x,y,z,aa){'use strict';var ba=v(x,y),ca=ba.getAllResources();for(var da=0;da<ca.length;da++)if(z===ca[da].message_id)return da;};o.prototype.findSnippetAtIndex=function(x,y,z,aa){'use strict';s(x,y,z);t.call(this,x,y,z,aa);};o.prototype.handleUpdate=function(x){'use strict';if(x.mercury_payload)this.$MercurySearchSnippetResults2.handleUpdate(x.mercury_payload);var y=x.search_snippets||{};Object.keys(y).filter(function(oa){return !!y[oa];}).forEach(function(oa){Object.keys(y[oa]).forEach(function(pa){if(!y[oa][pa].snippets)return;y[oa][pa].snippets.forEach(function(qa){qa.matched_keywords=r(qa.matched_keywords);});});});var z=x.offset,aa=[];for(var ba in y){var ca=y[ba];for(var da in ca){var ea=ca[da],fa=x.other_user_fbid||x.thread_fbid,ga=this.$MercurySearchSnippetResults3.getClientIDFromServerIDNow(da),ha=ea.snippets,ia=v(ba,ga),ja=ia.getCurrentArraySize();if(!fa){aa.push(ga);if(ja)continue;}else if(z!=ja)continue;var ka=j[ga][ba];ka.num_total_snippets=ea.num_total_snippets;var la=ha?ha.length:0;if(la>0)ia.addResourcesWithoutSorting(ha,ja);if(!fa||x.limit>la)if(ia.getCurrentArraySize()==ka.num_total_snippets)ia.setReachedEndOfArray();}if(!fa){var ma=u(ba),na=ma.getCurrentArraySize();if(z==na){ma.addResourcesWithoutSorting(aa,na);if(x.limit>aa.length)ma.setReachedEndOfArray();}}}};function p(x,y,z,aa,ba){if(k)if(!k.thread_id){var ca=u(k.query);ca.unsubscribe(k.subscriber_id);k=null;}var ca=u(y),da=aa+z,ea=ca.executeOrEnqueue(0,da,function(ha){var ia={};for(var ja=0;ja<ha.length;ja++){var ka=ha[ja],la=j[ka][y];ia[ka]={num_total_snippets:la.num_total_snippets,snippets:la.snippets_cbm.getAllResources()};}var ma=ca.hasReachedEndOfArray();ba(ia,ma);}),fa=ca.getUnavailableResources(ea);if(fa.length){k={query:y,thread_id:null,subscriber_id:ea};var ga={query:y,offset:aa,limit:z+1,snippetLimit:l};ga.identifier='thread_fbid';w(ga,x);}}function q(x,y,z,aa,ba){if(k)if(k.thread_id){var ca=v(k.query,k.thread_id);ca.unsubscribe(k.subscriber_id);k=null;}var ca=v(x,y),da=aa+z,ea=ca.executeOrEnqueue(0,da,function(){var ka=ca.getAllResources(),la=j[y][x].num_total_snippets;ba(ka,la);}),fa=ca.getUnavailableResources(ea);if(fa.length){k={query:x,thread_id:y,subscriber_id:ea};var ga={query:x,snippetOffset:aa,snippetLimit:z},ha=this.getThreadIDMap().getServerIDFromClientIDNow(y),ia=c('MercuryIDs').tokenize(y),ja=ia.type;if(ja=='user'){ga.other_user_fbid=ha;}else ga.thread_fbid=ha;ga.identifier='thread_fbid';w(ga,this.getFBID());}}function r(x){if(x instanceof Array){var y={};for(var z=0;z<x.length;z++)y[z.toString()]=x[z];return y;}else return x;}function s(x,y,z){}function t(x,y,z,aa){var ba=j[y][x],ca=ba.snippets_cbm.getAllResources(),da=ba.num_total_snippets,ea=ca.length;if(z<ea){aa(ca[z].message_id);return;}var fa=da-ea,ga=fa>n?n:fa;q.call(this,x,y,ga,ea,function(ha,ia){t.call(this,x,y,z,aa);});}function u(x){if(!i[x])i[x]=new (c('RangedCallbackManager'))();return i[x];}function v(x,y){if(!j[y])j[y]={};var z=j[y][x];if(!z){z={num_total_snippets:-1,snippets_cbm:new (c('RangedCallbackManager'))()};j[y][x]=z;}return z.snippets_cbm;}function w(x,y){x.client=h;c('MercuryServerDispatcher').trySend('/ajax/mercury/search_snippets.php',x,null,y);}Object.assign(o,c('MercurySingletonMixin'));f.exports=o;}),null);