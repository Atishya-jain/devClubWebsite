if (self.CavalryLogger) { CavalryLogger.start_js(["1Gief"]); }

__d('OmniMReducer',['AsyncRequest','immutable','MercuryActionType','MercuryConfig','MercuryIDs','MercuryPayloadSource','MNOmniMConstants','OmniMActions','OmniMActionType','OmniMDirectiveType','OmniMLogHelpers','P2PGKValues','XMessagingOmniMSetPrefController'],(function a(b,c,d,e,f,g){'use strict';var h,i=c('OmniMActions').Types,j=c('immutable').Set([c('MercuryActionType').SEND_MESSAGE,c('MercuryActionType').REPLACE_MESSAGE,c('MercuryActionType').USER_GENERATED_MESSAGE]),k=c('immutable').Set([c('MercuryActionType').SEND_MESSAGE,c('MercuryActionType').USER_GENERATED_MESSAGE]),l=2;function m(oa,pa){switch(oa.content_type){case 'text':return true;case 'location':if(pa===c('MNOmniMConstants').OMNIM)return c('MercuryConfig').OmniMLocationSuggestion;return true;case 'sticker':return c('MercuryConfig').MessengerStickerQuickReply;case 'ride_service':return c('MercuryConfig').MessengerRideServiceQuickReply;case 'p2p_payment':return c('P2PGKValues').P2PVisible&&c('MercuryConfig').MessengerP2PPaymentQuickReply;default:return false;}}function n(oa){return Array.isArray(oa);}function o(oa){if(!oa)return {};var pa=JSON.parse(oa)||{},qa=n(pa.quick_replies)?pa.quick_replies:[],ra=pa.m_directives;return {quickReplies:qa,directives:ra};}function p(oa){var pa=oa.other_user_fbid,qa=oa.thread_fbid;return pa?c('MercuryIDs').getThreadIDFromUserID(pa):c('MercuryIDs').getThreadIDFromThreadFBID(qa);}var q=c('immutable').Map((h={},h[c('OmniMActionType').CREATE_EVENT]='create_event',h[c('OmniMActionType').LOCATION]='location',h[c('OmniMActionType').PAYMENT]='p2p_payment',h[c('OmniMActionType').POLL]='poll',h[c('OmniMActionType').STICKER]='sticker',h[c('OmniMActionType').TEXT]='text',h[c('OmniMActionType').TRANSPORTATION]='ride_service',h[c('OmniMActionType').ORDER_FOOD]='order_food',h[c('OmniMActionType').MAKE_RESERVATION]='make_reservation',h[c('OmniMActionType').SCHEDULE_CALL]='schedule_call',h[c('OmniMActionType').LIVE_LOCATION]='live_location',h));function r(oa){var pa=oa.confidence,qa=oa.id,ra=oa.label,sa=oa.type,ta=oa.data,ua=oa.icon,va=oa.message_id,wa=oa.thread_key;return {content_type:q.get(sa+''),data:ta,image_url:ua,title:ra,confidence:pa,messageID:va,suggestionID:qa,threadID:p(wa),messageDepth:1};}function s(oa,pa){var qa=o(pa),ra=(qa.quickReplies||[]).filter(function(ta){return m(ta,c('MNOmniMConstants').QUICKREPLIES);}),sa=(qa.directives||[]).filter(function(ta){return ta.type===c('OmniMDirectiveType').ADD_ACTIONS;}).map(function(ta){return ta.data.actions;}).reduce(function(ta,ua){return ta.concat(ua);},[]).map(r).filter(function(ta){return m(ta,c('MNOmniMConstants').OMNIM);}).reduce(function(ta,ua){var va=ua.threadID;return ta.updateIn([va,'agentSuggestions'],[],function(wa){return wa.concat([ua]);});},c('immutable').Map({}));return sa.setIn([oa,'quickReplies'],ra);}function t(oa){var pa=oa.content_type;Object.keys(oa.data||{}).sort().map(function(qa){pa+=''+qa+oa.data[qa];});return pa;}function u(oa){var pa=c('immutable').Set(),qa=[];for(var ra=oa.length-1;ra>=0;ra--){var sa=oa[ra],ta=t(sa);if(!pa.has(ta)){pa=pa.add(ta);qa.unshift(sa);}}return qa;}function v(oa){var pa=0;return oa.filter(function(qa){if(qa.content_type==='sticker'){if(pa>=l)return false;pa+=1;}return true;});}function w(oa,pa,qa,ra){var sa=oa.getIn(['threadMetadata',pa,'timestamp']);if(sa&&sa>ra)return oa;var ta=qa.agentSuggestions,ua=qa.quickReplies,va=(oa.getIn(['suggestionsByThread',pa])||{}).agentSuggestions||[],wa=ta||[];if(va.length)wa=v(wa);var xa=u(wa.concat(va));return oa.setIn(['threadMetadata',pa,'timestamp'],ra).setIn(['suggestionsByThread',pa],{agentSuggestions:xa,quickReplies:ua});}function x(oa,pa,qa,ra,sa){var ta=s(pa,ra);return ta.reduce(function(ua,va,wa){return w(ua,wa,va.toJS(),sa);},oa);}function y(oa){if(!oa)return null;var pa=oa.agentSuggestions,qa=(pa||[]).reduce(function(ra,sa){if(sa.messageDepth>=c('MercuryConfig').OmniMMessagesToLive)return ra;return ra.concat([babelHelpers['extends']({},sa,{messageDepth:sa.messageDepth+1})]);},[]);return babelHelpers['extends']({},oa,{agentSuggestions:qa});}function z(oa,pa){var qa=pa.thread_id,ra=pa.message_id,sa=pa.platform_xmd,ta=pa.timestamp;if(k.has(pa.action_type))oa=oa.updateIn(['suggestionsByThread',qa],y);return x(oa,qa,ra,sa,ta);}function aa(oa,pa){if(pa.type!==i.MERCURY_DISPATCHED)return oa;var qa=pa.data;switch(pa.mercuryType){case 'update-messages':if(qa.payload_source!==c('MercuryPayloadSource').CLIENT_CHANNEL_MESSAGE)return oa;return qa.actions.filter(function(ra){return j.has(ra.action_type);}).reduce(z,oa);case 'invalidate-thread-state':return oa.deleteIn(['suggestionsByThread',qa.threadID]).deleteIn(['threadMetadata',qa.threadID]);case 'invalidate-global-state':return oa.set('suggestionsByThread',c('immutable').Map()).set('threadMetadata',c('immutable').Map());}return oa;}function ba(oa,pa){if(pa.type!==i.FETCH_SUGGESTIONS)return oa;var qa=pa.message,ra=pa.threadID;return x(oa,ra,qa.message_id,qa.platform_xmd,qa.timestamp);}function ca(oa){return oa.getIn(['prefs','suggestion_mode'],0);}function da(oa,pa){if(pa.type!==i.SUGGESTION_CLICKED)return oa;var qa=pa.option,ra=pa.position,sa=pa.source;if(sa===c('MNOmniMConstants').OMNIM)c('OmniMLogHelpers').suggestionClicked(qa,ra,ca(oa));return oa;}function ea(oa,pa){if(pa.type!==i.SUGGESTION_COMPLETED)return oa;var qa=pa.threadID,ra=pa.option,sa=pa.position,ta=pa.source;if(ta===c('MNOmniMConstants').OMNIM)c('OmniMLogHelpers').suggestionCompleted(ra,sa,ca(oa));return oa.deleteIn(['suggestionsByThread',qa]);}function fa(oa,pa){if(pa.type!==i.SUGGESTION_DISMISSED)return oa;var qa=pa.threadID,ra=pa.option,sa=pa.source,ta=pa.position;if(sa===c('MNOmniMConstants').OMNIM)c('OmniMLogHelpers').suggestionDismissed(ra,ta,ca(oa));var ua=oa.getIn(['suggestionsByThread',qa]);if(!ua||!ua.agentSuggestions)return oa;var va=ua.agentSuggestions.map(function(wa){if(wa.suggestionID===ra.suggestionID)return babelHelpers['extends']({},wa,{dismissed:true});return wa;});return oa.setIn(['suggestionsByThread',qa],babelHelpers['extends']({},ua,{agentSuggestions:va}));}function ga(oa,pa){if(pa.type!==i.SUGGESTIONS_DISMISSED_FOR_THREAD)return oa;var qa=pa.threadID,ra=oa.getIn(['suggestionsByThread',qa]);if(!ra||!ra.agentSuggestions)return oa;c('OmniMLogHelpers').barDismissed(ra.agentSuggestions,ca(oa));var sa=ra.agentSuggestions.map(function(ta,ua){if(ta.dismissed)return ta;c('OmniMLogHelpers').suggestionDismissed(ta,ua,ca(oa));return babelHelpers['extends']({},ta,{dismissed:true});});return oa.setIn(['suggestionsByThread',qa],babelHelpers['extends']({},ra,{agentSuggestions:sa}));}function ha(oa,pa){if(pa.type!==i.PREFS_UPDATED)return oa;var qa=pa.prefs;return oa.updateIn(['prefs'],function(ra){return ra.merge(c('immutable').fromJS(qa));});}function ia(oa,pa){if(pa.type!==i.SUGGESTION_MODE_SET)return oa;var qa=pa.mode,ra=c('XMessagingOmniMSetPrefController').getURIBuilder().getURI();new (c('AsyncRequest'))(ra).setMethod('POST').setData({suggestion_mode:qa}).send();return oa.setIn(['prefs','suggestion_mode'],qa);}function ja(oa,pa){if(pa.type!==i.SUGGESTION_DISPLAYED)return oa;var qa=pa.option,ra=pa.position;if(!qa.dismissed)c('OmniMLogHelpers').suggestionDisplayed(qa,ra,ca(oa));return oa;}function ka(oa,pa){if(pa.type!==i.SUGGESTION_DISAPPEARED)return oa;var qa=pa.option,ra=pa.position;if(!qa.dismissed)c('OmniMLogHelpers').suggestionDisappeared(qa,ra,ca(oa));return oa;}function la(oa,pa){if(pa.type!==i.BAR_TIMED_OUT)return oa;var qa=pa.threadID,ra=pa.options;c('OmniMLogHelpers').barDisappeared(ra,ca(oa));return oa.deleteIn(['suggestionsByThread',qa]);}function ma(oa,pa){if(pa.type!==i.BAR_DISAPPEARED)return oa;c('OmniMLogHelpers').barDisappeared(pa.options,ca(oa));return oa;}function na(oa,pa){if(pa.type!==i.BAR_DISPLAYED)return oa;c('OmniMLogHelpers').barDisplayed(pa.options,ca(oa));return oa;}f.exports={barDisappeared:ma,barDisplayed:na,barTimedOut:la,mercuryDispatch:aa,messageFetched:ba,prefsUpdated:ha,suggestionClicked:da,suggestionCompleted:ea,suggestionDisappeared:ka,suggestionDismissed:fa,suggestionDisplayed:ja,suggestionModeSet:ia,suggestionsDismissedForThread:ga};}),null);