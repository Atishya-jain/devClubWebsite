if (self.CavalryLogger) { CavalryLogger.start_js(["NzIqn"]); }

__d('MercurySearchContextResults',['KeyedCallbackManager','MercuryAPIArgsSource','MercuryIDs','MercuryThreadlistConstants','MercuryThreadIDMap','RangedCallbackManager','MercuryServerDispatcher','MercuryServerPayloadPreprocessor','WebMessengerConstants'],(function a(b,c,d,e,f,g){var h=c('MercuryThreadIDMap').get(),i=c('MercuryServerPayloadPreprocessor').get(),j=new (c('KeyedCallbackManager'))(),k=c('MercuryThreadlistConstants').WEBMESSENGER_SEARCH_SNIPPET_COUNT,l=c('WebMessengerConstants').MORE_SEARCH_CONTEXT_COUNT,m={getSearchContext:function q(r,s,t){if(r){var u=j.executeOrEnqueue(r,function(z){var aa=o(z,r);t(aa);}),v=j.getUnavailableResources(u);if(v.length){var w={message_id:r,limit:k+1},x=h.getServerIDFromClientIDNow(s),y=c('MercuryIDs').tokenize(s);if(y.type=='user'){w.other_user_fbid=x;}else w.thread_fbid=x;p(w);}return u;}},getMoreSearchContext:function q(r,s,t,u){if(r){var v=j.getResource(r);if(v){var w=t==c('WebMessengerConstants').MORE_SEARCH_CONTEXT_UP?v.up_message_ids:v.down_message_ids,x=w.getCurrentArraySize()+l,y=w.executeOrEnqueue(0,x,function(){var da=o(v,r);u(da);}),z=w.getUnavailableResources(y);if(z.length){var aa={message_id:r,limit:x,direction:t},ba=h.getServerIDFromClientIDNow(s),ca=c('MercuryIDs').tokenize(s);if(ca.type=='user'){aa.other_user_fbid=ba;}else aa.thread_fbid=ba;p(aa);}return y;}}},handleUpdate:function q(r){if(r.mercury_payload)i.handleUpdate(r.mercury_payload);var s=r.search_context||{};for(var t in s){var u=s[t],v=u.other_user_fbid||u.thread_fbid,w=h.getClientIDFromServerIDNow(v),x=!j.getResource(t),y=x?{thread_id:w,up_message_ids:new (c('RangedCallbackManager'))(),down_message_ids:new (c('RangedCallbackManager'))()}:j.getResource(t),z=x?k+1:l;if(u.up_message_ids&&(y.up_message_ids.getCurrentArraySize()===0||u.up_message_ids.length>=y.up_message_ids.getCurrentArraySize()))n(y.up_message_ids,u.up_message_ids,z);if(u.down_message_ids&&(y.down_message_ids.getCurrentArraySize()===0||u.down_message_ids.length>=y.down_message_ids.getCurrentArraySize()))n(y.down_message_ids,u.down_message_ids,z);if(x)j.setResource(t,y);}},unsubscribe:function q(r,s,t){if(s){var u=j.getResource(s);if(u){if(t==c('WebMessengerConstants').MORE_SEARCH_CONTEXT_UP){u.up_message_ids.unsubscribe(r);}else u.down_message_ids.unsubscribe(r);}else j.unsubscribe(r);}}};function n(q,r,s){var t=q.getCurrentArraySize(),u=r.length<t+s;if(r.length){q.removeAllResources();q.addResourcesWithoutSorting(r,0);}if(u)q.setReachedEndOfArray();}function o(q,r){var s=q.up_message_ids.hasReachedEndOfArray(),t=q.up_message_ids.getAllResources();if(!s)t.shift();var u=q.down_message_ids.hasReachedEndOfArray(),v=q.down_message_ids.getAllResources();if(!u)v.pop();return {thread_id:q.thread_id,message_id:r,up_message_ids:t,up_exhausted:s,down_message_ids:v,down_exhausted:u};}function p(q){q.client=c('MercuryAPIArgsSource').WEBMESSENGER;c('MercuryServerDispatcher').trySend('/ajax/mercury/search_context.php',q);}c('MercuryServerDispatcher').registerEndpoints({'/ajax/mercury/search_context.php':{mode:c('MercuryServerDispatcher').IMMEDIATE,handler:m.handleUpdate}});f.exports=m;}),null);